<th:block th:fragment="attendBox">
    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org" lang="en">
    <head>
        <meta charset="UTF-8">
        <title>출퇴근바</title>
        <style>
            .button-inactive {
                background-color: #e9ecef;
                pointer-events: none;
            }

            .button-active {
                background-color: #334466;
                color: #fff;
            }

            #horizon {
                border-bottom: black 1px solid;
            }

            #box {
                padding: 30px;
                border: 1px solid black;
                width: 250px;
            }

            /*#workType {*/
            /*    width: 50px;*/
            /*}*/

            select:disabled {
                background-color: white !important; /* 배경색 유지 */
                /*color: black; !important; !* 글자색 유지 *!*/
                opacity: 0.7;
            !important; /* 투명도 기본값 */
            }
        </style>
    </head>
    <body>
    <div id="box">
        <h4>현재 시각</h4>
        <p><span id="currentDay"></span></p>
        <h3 id="horizon"><span id="currentTime">&nbsp;</span></h3>
        <p>출근시각: <span id="startTime">미등록</span></p>
        <p>퇴근시각: <span id="endTime">미등록</span></p>
        <p>근무구분:<select id="workType" class="form-select">
            <option value="일반">일반</option>
            <option value="외근">외근</option>
            <option value="출장">출장</option>
        </select>
        </p>
        <button id="startButton" class="btn button-active btn-sm">출근하기</button>
        <button id="endButton" class="btn button-inactive btn-sm">퇴근하기</button>
    </div>
    <script th:inline="javascript">
        // 오늘 날짜 표시
        $(document).ready(function () {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
            const day = String(now.getDate()).padStart(2, '0');

            const formattedDate = year + "-" + month + "-" + day;
            $("#currentDay").text(formattedDate);

            // 페이지 로딩 시 AJAX로 출근 기록 확인
            $.ajax({
                url: /*[[@{/attend/record}]]*/ '', // 서버에서 출근 기록을 가져오는 URL
                method: "GET",
                dataType: "json",
                success: function (data) {
                    console.log(data.status);

                    if (data.status === 'empty') { // 출근 안한 경우
                        $("#workType").prop("disabled", false);
                    } else if (data.status === 'checkIn') { // 출근 상태
                        const inTime = getLocalTimeToString(data.attend.inTime);
                        $("#startTime").text(inTime);
                        $("#startButton").addClass("button-inactive").removeClass("button-active");
                        $("#endButton").addClass("button-active").removeClass("button-inactive");
                        $("#workType").val(data.type).prop("disabled", true);
                        setWorkType(data.attend.attendType);
                    } else if (data.status === 'checkOut') { // 퇴근까지 마친 상태
                        const inTime = getLocalTimeToString(data.attend.inTime);
                        const outTime = getLocalTimeToString(data.attend.outTime);
                        $("#startTime").text(inTime);
                        $("#endTime").text(outTime);
                        $("#startButton").addClass("button-inactive").removeClass("button-active");
                        $("#endButton").addClass("button-inactive").removeClass("button-active");
                        $("#workType").val(data.type).prop("disabled", true);
                        setWorkType(data.attend.attendType);
                    } else if (data.status === 'etc') { // 휴가나 출장 상태
                        $("#startButton, #endButton").addClass("button-inactive").removeClass("button-active");

                        // 서버에서 전달된 `attendType`을 텍스트로 표시 (이미 typeName이 반환됨)
                        const workTypeText = data.attend.attendType || "근무 유형 없음"; // 값이 없으면 기본 텍스트로 설정

                        // 선택박스를 텍스트로 대체
                        const customWorkTypeText = $('<span>')
                            .attr('id', 'customWorkType')
                            .text(workTypeText) // 서버에서 받은 근무 유형 텍스트
                            .css({
                                display: 'inline-block',
                                marginLeft: '10px',
                                padding: '5px',
                                border: '1px solid #ccc',
                                borderRadius: '5px',
                                backgroundColor: '#f9f9f9'
                            });

                        $("#workType").replaceWith(customWorkTypeText);
                    }
                },
                error: function () {
                    console.log("출근 기록을 가져오는 데 실패했습니다.");
                }
            });
        });

        function setWorkType(type) {
            const workTypeSelect = $("#workType");
            let optionFound = false;

            workTypeSelect.find('option').each(function () {
                if ($(this).val() === type) {
                    $(this).prop('selected', true);
                    optionFound = true;
                    return false; // 반복 종료
                }
            });

            if (!optionFound) {
                alert("서버에서 받은 근무 유형이 선택 옵션에 없습니다. 기본값으로 설정합니다.");
                workTypeSelect.val('일반').prop('selected', true);
            }
        }

        //시간 표시 설정
        function getLocalTimeToString(localDateTimeString) {
            // LocalDateTime 문자열에서 날짜와 시간 분리
            const [datePart, timePart] = localDateTimeString.split("T");
            const [year, month, day] = datePart.split("-").map(Number);
            const [hour, minute, second] = timePart.split(":").map(Number);

            // 로컬 시간대로 Date 객체 생성 (주의: month는 0부터 시작하므로 -1 필요)
            const date = new Date(year, month - 1, day, hour, minute, second);

            // 로컬 시간대에 맞춰 '오전/오후 HH:mm:ss' 형식으로 반환
            return date.toLocaleTimeString("ko-KR", {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true // 12시간 형식 (오전/오후)
            });
        }

        // 현재 시각 표시
        setInterval(() => {
            const now = new Date();
            $("#currentTime").text(now.toLocaleTimeString());
        }, 100);

        // 출근/퇴근 버튼 상태 전환
        $("#startButton").click(function () {
            const now = new Date().toLocaleTimeString();
            $("#startTime").text(now);
            $(this).addClass("button-inactive").removeClass("button-active");
            $("#endButton").addClass("button-active").removeClass("button-inactive");
            let type = $("#workType").val();

            if (!confirm("출근하시겠습니까?")) {
                return false;
            }

            // 출근 시간 저장을 위한 AJAX 요청
            $.ajax({
                url: /*[[@{/attend/in}]]*/'',
                method: "POST",
                data: {attendType: type},
                success: function () {
                    alert("출근하였습니다.")
                },
                error: function () {
                    alert("출근 처리 오류")
                }
            });
        });

        $("#endButton").click(function () {
            const now = new Date().toLocaleTimeString();
            $("#endTime").text(now);
            $(this).addClass("button-inactive").removeClass("button-active");
            $("#startButton").addClass("button-inactive").removeClass("button-active");

            if (!confirm("퇴근하시겠습니까?")) {
                return false;
            }
            // 퇴근 시간 저장을 위한 AJAX 요청
            $.ajax({
                url: /*[[@{/attend/out}]]*/'',
                method: "POST",
                success: function () {
                    alert("퇴근하였습니다.")
                },
                error: function () {
                    alert("퇴근 처리 오류")
                }
            });
        });
    </script>
    </body>

    </html>
</th:block>
