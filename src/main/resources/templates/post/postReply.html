<th:block th:replace="layout :: setContent(~{this::content})">
    <th:block th:fragment="content">
        <!DOCTYPE html>
        <html xmlns:th="http://www.thymeleaf.org" lang="en">
        <head>
            <link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs5.min.css" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs5.min.js"></script>
            <link rel="stylesheet" th:href="@{/css/boardHome.css}">
            <link rel="stylesheet" th:href="@{/css/postWrite.css}">
            <style>
                h1 {
                    font-size: 1.5rem;
                    text-align: center;
                    color: #1a92b9
                }

                .container {
                    width: 60%
                }

                label {
                    font-weight: bold
                }

                #upfile {
                    display: none
                }

                img {
                    width: 20px;
                }

                .attachFile {
                    border: 1px dashed;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 80px;
                    width: 85%;
                    border-radius: 10px;
                }

                .fileLabel {
                    margin: 0px 3px;
                    cursor: pointer;
                }

                .file-list {
                    display: none;
                    height: 130px;
                    overflow: auto;
                    border: 1px solid #989898;
                    padding: 10px;
                    margin: 0px 0px 1rem 15%;
                    border-radius: 10px;
                }

                .file-list .filebox p {
                    font-size: 14px;
                    margin-top: 10px;
                    display: inline-block;
                }

                .file-list .filebox .delete i {
                    color: #ff5353;
                    margin-left: 5px;
                }

                .form-group2, .form-group2-file {
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                }

                .boardName {
                    word-wrap: normal;
                    padding: 5px 15vh 5px 3px;
                    margin: 0px 5px;
                    font-size: 18px;
                    width: 300px;
                    border: 1px solid #ccc;
                    border-radius: 7px;
                }

                .form-control2 {
                    width: 85%;
                }

                .form-group-btn {
                    display: flex;
                    justify-content: flex-end;
                    height: 70px;
                    align-items: center;
                    margin-top: 10px;
                    gap: 20px;
                    margin-right: 3px;
                }

                .registerBtn {
                    width: 100px;
                    background: white;
                    color: #7f7f7f;
                    border: 1.5px solid #9d9c9c;
                    font-weight: bolder;
                }

                .labelName {
                    margin: 0px;
                    font-size: 18px;
                    font-weight: 600;
                    padding: 0px 0px 0px 10px;
                }

                .dragoverFile {
                    border: 3px solid #334466;
                    z-index: 1;
                }

                .hidden {
                    display: block;
                }

            </style>
            <script th:src="@{/js/writeform.js}"></script>
            <script th:inline="javascript">
                var fileNo = 0;
                var filesArr = [];
                var maxFileCnt = 5;   // ì²¨ë¶€íŒŒì¼ ìµœëŒ€ ê°œìˆ˜
                let totalFileSize = 0;

                let boardMap = /*[[${boardMap}]]*/ {};

                /* ì²¨ë¶€íŒŒì¼ ì¶”ê°€ */
                function addFiles(files) {
                    var attFileCnt = $('.filebox').length;
                    attFileCnt += $('.summernoteImg').length;
                    var remainFileCnt = maxFileCnt - attFileCnt;
                    var curFileCnt = files.length;

                    if (curFileCnt > remainFileCnt) {
                        alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ " + maxFileCnt + "ê°œ ê¹Œì§€ ì²¨ë¶€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }

                    for (const file of files) {
                        if (validation(file)) {
                            fileListAppendHtml(file);// fileList ì¶”ê°€
                        }
                    }

                    updateFileListVisibility();
                    $("input:file").val(""); // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                }

                //addFileê³¼ handleFilesì—ì„œ ê³µí†µëœ íŒŒì¼ ì²˜ë¦¬ ë¡œì§
                function addFile(obj) {
                    addFiles(obj.files);
                }

                function handleFiles(dragFiles) {
                    addFiles(dragFiles);
                }

                /* fileList html ì¶”ê°€ */
                function fileListAppendHtml(file) {
                    // íŒŒì¼ ê°ì²´ì— ê³ ìœ  fileNo ê°’ì„ ì¶”ê°€í•´ ë°°ì—´ì— ì €ì¥
                    file.fileNo = fileNo;
                    filesArr.push(file);

                    // ëª©ë¡ ì¶”ê°€
                    let htmlData = '';
                    htmlData += '<div id="file' + fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + file.name + '</p>';
                    htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><img src="/image/delete.png"/></a>';
                    htmlData += '</div>';
                    $('.file-list').append(htmlData);

                    fileNo++; // ê°’ ì¦ê°€
                }

                /* ì²¨ë¶€íŒŒì¼ ê²€ì¦ */
                function validation(file) {
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    const totalMaxSize = 30 * 1024 * 1024; // 30MB
                    totalFileSize += file.size;

                    if (file.name.length > 100) {
                        alert("íŒŒì¼ëª…ì´ 100ì ì´ìƒì¸ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else if (file.size > maxSize) {
                        alert("ìµœëŒ€ íŒŒì¼ ìš©ëŸ‰ì¸ 10MBë¥¼ ì´ˆê³¼í•œ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else if (totalFileSize > totalMaxSize) {
                        alert("ì „ì²´ íŒŒì¼ ìš©ëŸ‰ì¸ 30MBë¥¼ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.");
                    } else if (!file.name.includes('.')) {
                        alert("í™•ì¥ìê°€ ì—†ëŠ” íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        return true;
                    }
                    totalFileSize -= file.size;
                    return false;
                }

                /* ì²¨ë¶€íŒŒì¼ ì‚­ì œ */
                function deleteFile(deleteNo) {
                    // ì‚­ì œí•  íŒŒì¼ ì°¾ê¸°
                    let fileToDelete = filesArr.find(file => file.fileNo === deleteNo);

                    if (fileToDelete) {
                        totalFileSize -= fileToDelete.size; // í•´ë‹¹ fileì˜ sizeë§Œí¼ ë¹¼ê¸°
                    }

                    // filesArr ë°°ì—´ì—ì„œ ì‚­ì œí•  íŒŒì¼ì„ fileNoë¡œ ì°¾ìŒ
                    filesArr = filesArr.filter(file => file.fileNo !== deleteNo);

                    // íŒŒì¼ ëª©ë¡ì—ì„œ ì‚­ì œ
                    $("#file" + deleteNo).remove();

                    // íŒŒì¼ ëª©ë¡ì´ ë¹„ì–´ ìˆìœ¼ë©´ ìˆ¨ê¹€ ì²˜ë¦¬
                    updateFileListVisibility();
                }

                /* íŒŒì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ */
                function updateFileListVisibility() {
                    $('.file-list').toggleClass('hidden', filesArr.length !== 0);
                }


                /* í¼ ì „ì†¡ */
                function submitForm() {
                    var form = document.querySelector("form[name='boardform']");
                    var formData = new FormData(form);

                    // ì‚­ì œë˜ì§€ ì•Šì€ íŒŒì¼ë§Œ í¼ë°ì´í„°ì— ë‹´ê¸°
                    filesArr.forEach(file => {
                        formData.append("attachFiles", file);
                    });

                    for (let [key, value] of formData.entries()) {
                        if (key === 'files') {
                            formData.delete(key);
                        }
                    }

                    $.ajax({
                        method: 'POST',
                        url: 'replyProcess',
                        dataType: 'json',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        success: function (data) {
                            console.log("data = ", data)
                            if (data == null || data === "" || data.postId === -1) {
                                alert('ê²Œì‹œê¸€ì´ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
                                return location.href = "/board/home";
                            }
                            alert('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            return location.href = `/board/post/detail?no=${data.postId}&boardName1=${encodeURIComponent(data.boardDTO.boardName1)}&boardName2=${encodeURIComponent(data.boardDTO.boardName2)}&page=1`;
                        },
                        error: function (xhr, desc, err) {
                            alert('ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
                            location.href = "/board/home";
                        }
                    });
                }

                //boardName2ë¥¼ boardName1ì— ë§ê²Œ ë°”ê¿ˆ
                function changeBoardName2(boardName1Value, companyBoards, generalBoards, departmentBoards) {
                    let $boardName2 = $('#boardName2'); // ë‘ ë²ˆì§¸ select ì´ˆê¸°í™”
                    $boardName2.empty();

                    if (boardName1Value === 'ì „ì‚¬ê²Œì‹œíŒ') {
                        $.each(companyBoards, function (index, companyBoard) {
                            $boardName2.append('<option value="' + companyBoard + '">' + companyBoard + '</option>');
                        });
                    } else if (boardName1Value === 'ì¼ë°˜ê²Œì‹œíŒ') {
                        $.each(generalBoards, function (index, generalBoard) {
                            $boardName2.append('<option value="' + generalBoard + '">' + generalBoard + '</option>');
                        });
                    } else if (boardName1Value === 'ë¶€ì„œê²Œì‹œíŒ') {
                        $.each(departmentBoards, function (index, departmentBoard) {
                            $boardName2.append('<option value="' + departmentBoard + '">' + departmentBoard + '</option>');
                        });
                    }
                }

                function filterBoardName2(boardName1) {
                    let filteredArray = []; // ê²°ê³¼ë¥¼ ë‹´ì„ ë°°ì—´
                    for (const value of boardMap[boardName1]) {
                        filteredArray.push(value);
                    }
                    return filteredArray;
                }

                $(function () {
                    let companyBoards = filterBoardName2('ì „ì‚¬ê²Œì‹œíŒ');
                    let generalBoards = filterBoardName2('ì¼ë°˜ê²Œì‹œíŒ');
                    let departmentBoards = filterBoardName2('ë¶€ì„œê²Œì‹œíŒ');

                    var BoardName2Value = $('#boardName2Hidden').val();
                    let boardName1Value;

                    if (BoardName2Value === '' || BoardName2Value == null) {//ê²Œì‹œíŒ í™ˆì—ì„œ ê¸€ì“°ê¸° ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²½ìš° ì´ˆê¸°í™”
                        BoardName2Value = 'ê³µì§€ì‚¬í•­';
                    }

                    // BoardName2Textì˜ ë”°ë¼ BoardName1 êµ¬í•˜ê¸°
                    if (companyBoards.includes(BoardName2Value)) {
                        boardName1Value = 'ì „ì‚¬ê²Œì‹œíŒ';
                    } else if (departmentBoards.includes(BoardName2Value)) {
                        boardName1Value = 'ë¶€ì„œê²Œì‹œíŒ';
                    } else {
                        boardName1Value = 'ì¼ë°˜ê²Œì‹œíŒ';
                    }

                    changeBoardName2(boardName1Value, companyBoards, generalBoards, departmentBoards);//boardName2ë¥¼ boardName1ì— ë§ê²Œ ë°”ê¿ˆ
                    $('#boardName1').val(boardName1Value);
                    $('#boardName2').val(BoardName2Value);

                    // $(".boardName2,.left a").removeClass('menuActive');

                    // dragover ì´ë²¤íŠ¸: ë“œë˜ê·¸í•œ íŒŒì¼ì´ attachFlie ì˜ì—­ì— ìˆì„ ë•Œ
                    $('.attachFile, .file-list').on('dragover', function (event) {
                        event.preventDefault();
                        $(this).addClass('dragoverFile');
                    });

                    $('.attachFile, .file-list').on('dragleave', function () {
                        $(this).removeClass('dragoverFile');
                    });

                    $('.attachFile, .file-list').on('drop', function (event) {
                        event.preventDefault();  // ê¸°ë³¸ ë™ì‘ì„ ì·¨ì†Œ
                        $(this).removeClass('dragoverFile');

                        var dragFiles = event.originalEvent.dataTransfer.files;  // ë“œë¡­ëœ íŒŒì¼ë“¤
                        handleFiles(dragFiles);  // ë“œë˜ê·¸ëœ íŒŒì¼ ì²˜ë¦¬
                    });

                });

                //Drop ì˜ì—­ì™¸ì— íŒŒì¼ ëŒì–´ë‹¤ ë†“ì•˜ì„ ë•Œ ë¸Œë¼ìš°ì ¸ ë™ì‘ë§‰ê¹…
                document.addEventListener("dragover", function (event) {
                    event.preventDefault();
                });

                document.addEventListener("drop", function (event) {
                    event.preventDefault();
                });
            </script>
        </head>
        <body>
        <div class="main">
            <th:block th:replace="~{board/sidebar :: boardSidebarFragment}"/>

            <div class="content">
                <div class="boardTitle">ê²Œì‹œê¸€ ë‹µê¸€</div>
                <div class="boardContent">
                    <form method="post" enctype="multipart/form-data"
                          name="boardform" onsubmit="event.preventDefault(); submitForm();">
                        <div class="form-group2 form-group2-title">
                            <input type="hidden" name="postId" th:value='${postMap["post_id"]}'/>
                            <input type="hidden" id="boardName1Hidden" name="boardName1"
                                   th:value='${boardDTO.boardName1}'/>
                            <input type="hidden" id="boardName2Hidden" name="boardName2"
                                   th:value='${boardDTO.boardName2}'/>
                            <input type="hidden" name="postReRef" th:value="${postMap['post_re_ref']}"/>
                            <input type="hidden" name="postReLev" th:value="${postMap['post_re_lev']}"/>
                            <input type="hidden" name="postReSeq" th:value="${postMap['post_re_seq']}"/>
                            <label class="labelName">
                                To.
                                <select id="boardName1" name="boardName1" class="boardName" disabled>
                                    <option value="ì „ì‚¬ê²Œì‹œíŒ">ì „ì‚¬ê²Œì‹œíŒ</option>
                                    <option value="ì¼ë°˜ê²Œì‹œíŒ">ì¼ë°˜ê²Œì‹œíŒ</option>
                                    <option value="ë¶€ì„œê²Œì‹œíŒ">ë¶€ì„œê²Œì‹œíŒ</option>
                                </select>
                                <select id="boardName2" name="boardName2" class="boardName" disabled>
                                    <option value="ê³µì§€ì‚¬í•­">ê³µì§€ì‚¬í•­</option>
                                    <option value="ì£¼ê°„ì‹ë‹¨í‘œ">ì£¼ê°„ì‹ë‹¨í‘œ</option>
                                    <option value="FAQ">FAQ</option>
                                </select>
                            </label>
                        </div>
                        <div class="form-group2">
                            <label class="labelName">ì œëª©</label>
                            <input name="postSubject" id="board_subject" type="text" maxlength="100"
                                   class="form-control2" placeholder="Enter board_subject"
                                   th:value="|Re: ${postMap['post_subject']}|" required>
                        </div>
                        <div class="form-group2-file">
                            <label class="labelName">íŒŒì¼ì²¨ë¶€</label>
                            <div class="attachFile">
                                <img th:src="@{/image/attach.png}" alt="íŒŒì¼ì²¨ë¶€">
                                ì´ ê³³ì— íŒŒì¼ì„ ë“œë˜ê·¸ í•˜ì„¸ìš”. ë˜ëŠ”
                                <label class="fileLabel">
                                    íŒŒì¼ì„ íƒ
                                    <input type="file" id="upfile" onchange="addFile(this);" multiple/>
                                </label>
                            </div>
                        </div>
                        <div class="file-list"></div>
                        <textarea class="summernote form-control2" id="board_content" name="postContent"
                                  required></textarea>
                        <div class="form-group-btn">
                            <button type="submit" class="btn registerBtn">ë“±ë¡</button>
                            <button type="reset" id="registerBtn" class="btn registerBtn tr-post"
                                    onClick="history.go(-1)">ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            let uploadedFiles = []; // ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ë“¤ì„ ì €ì¥í•  ë°°ì—´
            let uuidList = [];
            let imgFileNo = 0;

            $(document).ready(function () {
                $('.summernote').summernote({
                    height: 400,
                    minHeight: 400,
                    maxHeight: null,
                    lang: 'ko-KR',
                    toolbar: [
                        ['fontname', ['fontname']],
                        ['fontsize', ['fontsize']],
                        ['style', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
                        ['color', ['forecolor', 'color']],
                        ['table', ['table']],
                        ['para', ['ul', 'ol', 'paragraph']],
                        ['height', ['height']],
                        ['insert', ['picture', 'link']],
                        ['view', ['fullscreen', 'help']]
                    ],
                    fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'ë§‘ì€ ê³ ë”•', 'ê¶ì„œ', 'êµ´ë¦¼ì²´', 'êµ´ë¦¼', 'ë‹ì›€ì²´', 'ë°”íƒ•ì²´'],
                    fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '22', '24', '28', '30', '36', '50', '72'],
                    focus: true,
                    callbacks: {
                        onInit: function () {
                            let targetNode = document.querySelector('.note-editable');

                            if (!targetNode) {
                                // console.warn("âŒ targetNode (note-editable) ì°¾ì„ ìˆ˜ ì—†ìŒ");
                                return;
                            }

                            // console.log("âœ… observer ì‹œì‘", targetNode);

                            // **MutationObserverë¡œ ì´ë¯¸ì§€ ì‚­ì œ ê°ì§€**
                            const observer = new MutationObserver(function (mutations) {
                                mutations.forEach(function (mutation) {
                                    mutation.removedNodes.forEach(function (removedNode) {
                                        if (removedNode.nodeType === 1 && removedNode.tagName === 'IMG' && $(removedNode).hasClass('summernoteImg')) {
                                            let deletedFilename = $(removedNode).attr('data-filename');
                                            let deletedFileNo = $(removedNode).attr('data-fileNo');
                                            let uuid = $(removedNode).attr('data-uuid');
                                            // console.log("ğŸ—‘ ì‚­ì œ ê°ì§€ëœ íŒŒì¼:", deletedFilename+"::"+deletedFileNo);

                                            // ì‚­ì œí•  íŒŒì¼ ì°¾ê¸°
                                            let fileToDeletes = uploadedFiles.filter(item => item.file.name === deletedFilename && String(item.fileNo) === String(deletedFileNo));
                                            let fileToDelete = fileToDeletes.map(item => item.file);

                                            if (fileToDelete[0]) {
                                                totalFileSize -= fileToDelete[0].size; // í•´ë‹¹ fileì˜ sizeë§Œí¼ ë¹¼ê¸°
                                            }

                                            // `uploadedFiles`ì—ì„œ ì œê±°
                                            uploadedFiles = uploadedFiles.filter(item => !(item.file.name === deletedFilename && String(item.fileNo) === String(deletedFileNo)));
                                            // console.log("ğŸ“‚ ì—…ë°ì´íŠ¸ëœ uploadedFiles:", uploadedFiles);

                                            // ì„œë²„ì— ì‚­ì œ ìš”ì²­
                                            $.ajax({
                                                url: `/board/post/deleteImage?uuid=${uuid}`,
                                                type: "POST",
                                                success: function (response) {
                                                    console.log("âœ… ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ:");
                                                },
                                                error: function () {
                                                    console.log("âŒ ì„œë²„ ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨");
                                                }
                                            });
                                        }
                                    });
                                });
                            });

                            // **ì˜µì €ë²„ ê°ì‹œ ì‹œì‘ (subtree: true ì¶”ê°€)**
                            observer.observe(targetNode, {childList: true, subtree: true});
                        },
                        onImageUpload: function (files) {
                            let attFileCnt = $('.filebox').length;
                            attFileCnt += $('.summernoteImg').length;
                            var remainFileCnt = maxFileCnt - attFileCnt;
                            var curFileCnt = files.length;
                            let imageFormData = new FormData();

                            if (curFileCnt > remainFileCnt) {
                                alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ " + maxFileCnt + "ê°œ ê¹Œì§€ ì²¨ë¶€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                                return;
                            }

                            // ì—¬ëŸ¬ íŒŒì¼ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ë°˜ë³µë¬¸ì„ ì‚¬ìš©
                            let filesArray = Array.from(files); // FileList â†’ ë°°ì—´ ë³€í™˜
                            let isAllValid = filesArray.every(file => validation(file));
                            if (isAllValid) {
                                for (const file of files) {
                                    imageFormData.append("images", file);
                                }
                            }

                            $.ajax({
                                url: "/board/post/upload", // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬ ì„œë²„ URL
                                type: "POST",
                                data: imageFormData,
                                processData: false,
                                contentType: false,
                                success: function (response) {
                                    // ì„œë²„ì—ì„œ ë°˜í™˜ëœ URLì„ ë°°ì—´ë¡œ ë°›ìŒ (ì—¬ëŸ¬ ì´ë¯¸ì§€ ì²˜ë¦¬)
                                    let imageUrls = response.urls;
                                    let fileUUIDList = response.uuidList;

                                    fileUUIDList.forEach(uuid => {
                                        uuidList.push(uuid);
                                    })

                                    // ì—…ë¡œë“œëœ ê° ì´ë¯¸ì§€ì˜ URLì„ Summernoteì— ì‚½ì…
                                    for (let i = 0; i < files.length; i++) {
                                        imgFileNo += 1;

                                        let img = $('<img>')
                                            .attr('src', imageUrls[i]) // ì„œë²„ì—ì„œ ë°›ì€ URL
                                            .attr('data-fileNo', imgFileNo)
                                            .attr('data-filename', files[i].name) // íŒŒì¼ëª…ì„ ì €ì¥
                                            .attr('data-uuid', fileUUIDList[i])
                                            .addClass('summernoteImg')
                                            .css('width', '70%');

                                        $('.summernote').summernote('insertNode', img[0]);
                                        uploadedFiles.push({ // ì—…ë¡œë“œëœ íŒŒì¼ì„ ë°°ì—´ì— ì¶”ê°€
                                            file: files[i],        // ì‹¤ì œ íŒŒì¼ ê°ì²´
                                            fileNo: imgFileNo      // ê³ ìœ í•œ fileNo ì¶”ê°€
                                        });
                                    }

                                    // console.log("ğŸ“‚ í˜„ì¬ uploadedFiles:", uploadedFiles);
                                },
                                error: function () {
                                    alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
                                }
                            });
                        }
                    }
                });

                $('.boardContent .active').removeClass('active');
            });
        </script>
        </body>
        </html>
    </th:block>
</th:block>