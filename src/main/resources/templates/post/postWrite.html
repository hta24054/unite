<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<script th:src="@{/js/writeform.js}"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
	<link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs4.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-bs4.min.js"></script>
	<style>
		.main {
			font-family: Arial, sans-serif;
			padding: 60.8px 0px 0px;
			position: absolute;
			top: 0px;
			width: 100%;
			height: 100%;
		}

		.header{
			position: fixed;
			z-index: 1;
			width: 100%;

		}

		/* 왼쪽 아코디언 메뉴 */
		.sidebar {
			min-height: calc(100vh - 61px);
			height: auto !important;
			margin-top: 0px !important;
			/*
            height: 100vh;
            width: 250px;
            border-right: 1px solid #ccc;
            position: fixed;
            */
		}

		.sidebar .title{
			padding-bottom: 20px;
		}

		.sidebar h2 {
			margin: 0px;;
			color: rgb(51, 68, 102);
			font-size: 30px;
			font-weight: bold;
		}

		.accordion button {
			width: 100%;
			background-color: #f9f9f9;
			border: 1px solid #ccc;
			padding: 5px;
			text-align: left;
			cursor: pointer;
			font-size: 16px;
			outline: none;
			transition: background-color 0.3s;
			margin-bottom: 5px;
		}

		.accordion button:hover {
			background-color: #ddd;
		}

		.panel {
			display: none;
			background-color: white;
			overflow: hidden;
			margin-bottom: 10px;
		}

		.panel .boardName2 {
			padding: 5px 15px;
			color: #333;
			font-size: 14px;
		}

		.panel .boardName2:hover {
			background-color: #f0f0f0;
		}

		/* 오른쪽 게시판 영역 */
		.content {
			margin-left: 350px;
			overflow-y: auto;
			padding: 15px 20px 0px;
			min-height: calc(100vh - 61px);
			/*
            min-height: 100vh;
            height: 100%;
            width: calc(100% - 200px);
            */
		}

		.post {
			border-bottom: 1px solid #ddd;
			padding: 15px 0;
		}

		.post h3 {
			margin: 0;
			font-size: 16px;
		}

		.post p {
			margin: 5px 0;
			color: #666;
		}

		.post .info {
			font-size: 12px;
			color: #999;
		}
		.boardTitle{
			font-size: 2rem;
			font-weight:normal;
			padding: 20px;
			border-bottom: 1px solid #ccc;
		}
		#boardHome{
			cursor: pointer;
		}
		.boardWrite{
			padding: 5px 25px 20px;
			height: 80px;
		}
		.writeBtn{
			width: 100%;
			height: 100%;
			border-radius: 5px;
			border: 1px solid #ccc;
			background: white;
		}



		.board-container {
			font-family: Arial, sans-serif;
			border-bottom: 1px solid #ccc;
			padding: 15px 25px;
			width: 100%;
			min-height: 200px;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}
		.board-header {
			font-size: 17px;
			color: #666;
			margin-top: 8px;
			font-weight: 500;
		}
		.board-title {
			font-size: 20px;
			font-weight: 600;
			margin-bottom: 4px;
			display: flex;
			align-items: center;
		}
		.board-title span {
			color: #99B;
		}
		.board-content {
			font-size: 18px;
			color: #999;
			margin-bottom: 10px;
		}
		.board-footer {
			display: flex;
			align-items: center;
			font-size: 15px;
			color: #666;
		}
		.board-footer img {
			border-radius: 50%;
			width: 24px;
			height: 24px;
			margin-right: 6px;
			border: 1px solid gray;
		}
		.board-footer .username {
			margin-right: 10px;
			font-weight: bold;
		}
		.board-footer .date {
			color: #999;
		}
		.icon {
			display: inline-block;
			width: 25px;
			height: 25px;
			background-color: #ddd;
			border-radius: 50%;
			text-align: center;
			line-height: 16px;
			font-size: 12px;
			color: #666;
			margin: 0px 3px 0px 10px;
		}

		nav{
			z-index:1;
		}

		.tr-post:hover{
			background-color: rgba(0, 0, 0, .05);
			cursor: pointer;
		}

		.menuActive{
			font-weight: bold;
			font-size: 23px;
			color: #334466;
		}

		.side-box-shadow-option1{
			box-shadow:none !important;
		}

		.side-box-shadow-option2{
			box-shadow: inset 5px 0px 15px 0 rgba(0, 0, 0, 0.2);
		}

	</style>
<style>
	form[name=boardform]{
		padding : 20px 60px;
	}

	h1{font-size: 1.5rem; text-align: center; color:#1a92b9}
	label{font-weight: bold}
	#upfile{display: none}
	img{width: 20px;}
	.attachFile{
		border: 1px dashed;
		display: flex;
	    justify-content: center;
	    align-items: center;
	    height: 80px;
	    width: 85%;
	    border-radius: 10px;
	}
	
	.fileLabel{
		margin:0px 3px;
		cursor: pointer;
	}
	
	.file-list {
	    display: none;
	    height: 130px;
	    overflow: auto;
	    border: 1px solid #989898;
	    padding: 10px;
	    margin: 0px 0px 1rem 15%;
	    border-radius: 10px;
	}
	.file-list .filebox p {
	    font-size: 14px;
	    margin-top: 10px;
	    display: inline-block;
	}
	.file-list .filebox .delete i{
	    color: #ff5353;
	    margin-left: 5px;
	}
	.form-group2,.form-group2-file{
		margin-bottom: 1rem;
	    display: flex;
	    align-items: center;
	    justify-content: space-between;
	}
	.boardName{
		word-wrap: normal;
	    padding: 5px 15vh 5px 3px;
	    margin: 0px 5px;
	    font-size: 18px;
	    width: 300px;
	    border: 1px solid #ccc;
	}
	.form-control2{
		width: 85%;
	}
	.form-group-btn{
		display: flex;
	    justify-content: center;
	    height: 70px;
	    align-items: center;
	    margin-top: 10px;
	}
	.registerBtn{
		width: 100px;
	    background: white;
	    color: #7f7f7f;
	    border: 1.5px solid #9d9c9c;
	    font-weight: bolder;
	}
	.labelName{
		margin: 0px;
	    font-size: 18px;
	    font-weight: 600;
	    padding: 0px 0px 0px 10px;
	}
	.dragoverFile{
        border:3px solid #334466;
        z-index : 1;
	}
	.hidden {
    	display: block;
	}
	
</style>
<script>
var fileNo = 0;
var filesArr = [];
var maxFileCnt = 5;   // 첨부파일 최대 개수

var companyBulletinBoards = ['공지사항', '주간식단표', 'FAQ'];

/* 첨부파일 추가 */
function addFiles(files) {
    var attFileCnt = $('.filebox').length;
    var remainFileCnt = maxFileCnt - attFileCnt;
    var curFileCnt = files.length;

    if (curFileCnt > remainFileCnt) {
        alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
        return;
    }

    for (const file of files) {
    	if (validation(file)) {
            fileListAppendHtml(file);// fileList 추가
        }
    }

    updateFileListVisibility();
    $("input:file").val(""); // 파일 입력 필드 초기화
}

//addFile과 handleFiles에서 공통된 파일 처리 로직
function addFile(obj) {
    addFiles(obj.files);
}

function handleFiles(dragFiles) {
    addFiles(dragFiles);
}

/* fileList html 추가 */
function fileListAppendHtml(file){
	// 파일 객체에 고유 fileNo 값을 추가해 배열에 저장
	file.fileNo = fileNo;
	filesArr.push(file);
	
	// 목록 추가
	let htmlData = '';
	htmlData += '<div id="file' + fileNo + '" class="filebox">';
	htmlData += '   <p class="name">' + file.name + '</p>';
	htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><img src="/image/delete.png"/></a>';
	htmlData += '</div>';
	$('.file-list').append(htmlData);
	
	fileNo++; // 값 증가
}

/* 첨부파일 검증 */
function validation(file) {
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.name.length > 100) {
        alert("파일명이 100자 이상인 파일은 제외되었습니다.");
    } else if (file.size > maxSize) {
        alert("최대 파일 용량인 100MB를 초과한 파일은 제외되었습니다.");
    } else if (!file.name.includes('.')) {
        alert("확장자가 없는 파일은 제외되었습니다.");
    } else {
        return true;
    }
    return false;
}

/* 첨부파일 삭제 */
function deleteFile(deleteNo) {

    // filesArr 배열에서 삭제할 파일을 fileNo로 찾음
    filesArr = filesArr.filter(file => file.fileNo !== deleteNo);

    // 파일 목록에서 삭제
    $("#file" + deleteNo).remove();

    // 파일 목록이 비어 있으면 숨김 처리
    updateFileListVisibility();
}

/* 파일 목록이 비어있으면 숨김 처리 */
function updateFileListVisibility() {
    $('.file-list').toggleClass('hidden', filesArr.length !== 0);
	updateDividerHeight();
}

/* 폼 전송 */
function submitForm() {
    var form = document.querySelector("form[name='boardform']");
    var formData = new FormData(form);
    var j = 0;

    // 삭제되지 않은 파일만 폼데이터에 담기
    filesArr.forEach(file => {
        formData.append("files", file);
    });

    $.ajax({
        method: 'POST',
        url: 'add',
        dataType: 'json',
        data: formData,
        processData: false,
        contentType: false,
        cache: false,
        success: function (data) {
			if(data){
				alert('게시글이 작성되었습니다.');
				return location.href = "../home";
			}
			alert('게시글이 작성 중 오류가 발생하였습니다.');
            location.href = "../home";
        },
        error: function (xhr, desc, err) {
            alert('에러가 발생하였습니다.');
            location.href = "../home";
        }
    });
}

//boardName2를 boardName1에 맞게 바꿈
function changeBoardName2(boardName1Value, departmentBoards){
	let $boardName2 = $('#boardName2'); // 두 번째 select 초기화
    $boardName2.empty();

	if (boardName1Value === '전사게시판') {
		$.each(companyBulletinBoards, function(index, companyBulletinBoard) {
			$boardName2.append('<option value="' + companyBulletinBoard + '">' + companyBulletinBoard + '</option>');
		});
	}else if (boardName1Value === '일반게시판') {
		$boardName2.append('<option value="' + '일반게시판' + '">' + '일반게시판' + '</option>');
	}else if (boardName1Value === '부서게시판') {
		$.each(departmentBoards, function(index, departmentBoard) {
			$boardName2.append('<option value="' + departmentBoard + '">' + departmentBoard + '</option>');
		});
	}
	
}

function filterBoardName2() {
    const excludedValues = ['공지사항', '주간식단표', 'FAQ', '일반게시판']; // 제외할 값들
    let filteredArray = []; // 결과를 담을 배열

    $('.boardName2').each(function() {
        const value = $(this).text(); // .boardName2 요소의 값 가져오기
        if (!excludedValues.includes(value)) { // 제외할 값에 포함되지 않으면 추가
            filteredArray.push(value);
        }
    });

    return filteredArray; // 필터링된 배열 반환
}

$(function(){
	var departmentBoards = filterBoardName2();
	console.log(departmentBoards);
	
	var BoardName2Value = $('.boardName2').filter(function() {
	    return $(this).css('font-weight') === 'bold' || $(this).css('font-weight') === '700';
	}).text();
	
	let boardName1Value;
	
	if(BoardName2Value == ''||BoardName2Value == null){//게시판 홈에서 글쓰기 버튼을 누를 경우 초기화
		BoardName2Value='공지사항';
	}
	
	// BoardName2Text의 따라 BoardName1 구하기
	if (companyBulletinBoards.includes(BoardName2Value)) {
		boardName1Value='전사게시판';
	} else if(departmentBoards.includes(BoardName2Value)){
		boardName1Value='부서게시판';
	} else{
		boardName1Value='일반게시판';
	}
	
	changeBoardName2(boardName1Value, departmentBoards);//boardName2를 boardName1에 맞게 바꿈
	$('#boardName1').val(boardName1Value);
	$('#boardName2').val(BoardName2Value);
	
	$(".boardName2,.left a").removeClass('menuActive');
	
	//boardName1 select를 바꿀때마다 boardName2가 같이 바뀜
	$('#boardName1').change(function() {
		let boardName1Value = $(this).val();  // 첫 번째 select의 선택 값
		
		changeBoardName2(boardName1Value, departmentBoards);//boardName2를 boardName1에 맞게 바꿈
	});
	
	
	// dragover 이벤트: 드래그한 파일이 attachFlie 영역에 있을 때
    $('.attachFile').on('dragover', function(event) {
	    event.preventDefault();
	    $(this).addClass('dragoverFile');
	});
	
	$('.attachFile').on('dragleave', function() {
	    $(this).removeClass('dragoverFile');
	});
	
    $('.attachFile').on('drop', function(event) {
        event.preventDefault();  // 기본 동작을 취소
        $(this).removeClass('dragoverFile');
	
        var dragFiles = event.originalEvent.dataTransfer.files;  // 드롭된 파일들
        handleFiles(dragFiles);  // 드래그된 파일 처리
    });

});

//Drop 영역외에 파일 끌어다 놓았을 때 브라우져 동작막깅
document.addEventListener("dragover", function (event) {
    event.preventDefault();
});

document.addEventListener("drop", function (event) {
    event.preventDefault();
});
</script>
</head>
<body>
	<link rel="stylesheet" th:href="@{/css/leftbar.css}">
	<script th:src="@{/js/leftbar.js}"></script>
	<div class="main">
		<th:block th:replace="~{/board/sidebar :: boardSidebarFragment}"/>

		<div class="content">
			<div class="boardTitle">글쓰기</div>
			<div class="boardContent">
				<form method="post" enctype="multipart/form-data"
					  name="boardform" onsubmit="event.preventDefault(); submitForm();">
					<div class="form-group2">
						<label class="labelName">
							To.
							<select id="boardName1" name="boardName1" class="boardName">
								<option value="전사게시판" th:if="${boardName1 == '전사게시판' ? 'selected' : ''}">전사게시판</option>
								<option value="일반게시판" th:if="${boardName1 == '일반게시판' ? 'selected' : ''}">일반게시판</option>
								<option value="부서게시판" th:if="${boardName1 == '부서게시판' ? 'selected' : ''}">부서게시판</option>
							</select>
							<select id="boardName2" name="boardName2" class="boardName">
								<option value="공지사항"   	th:if="${boardName2 == '공지사항' ? 'selected' : ''}">공지사항</option>
								<option value="주간식단표"	th:if="${boardName2 == '주간식단표' ? 'selected' : ''}">주간식단표</option>
								<option value="FAQ" 	 	th:if="${boardName2 == 'FAQ' ? 'selected' : ''}">FAQ</option>
							</select>
						</label>
					</div>
					<div class="form-group2">
						<label for="board_subject" class="labelName">제목</label>
						<input name="postSubject" id="board_subject" type="text" maxlength="100"
							   class="form-control2" placeholder="제목을 입력하세요" style="padding-left: 10px;" required>
					</div>
					<div class="form-group2-file">
						<label class="labelName">파일첨부</label>
						<div class="attachFile">
							<img th:src="@{/image/attach.png}" alt="파일첨부">
							이 곳에 파일을 드래그 하세요. 또는
							<label class="fileLabel">
								파일선택
								<input type="file" name="files" id="upfile" onchange="addFile(this);" multiple />
							</label>
						</div>
					</div>
					<div class="file-list"></div>
					<textarea class="summernote form-control2" id="board_content" name="postContent" required></textarea>
					<div class="form-group-btn">
						<button type="submit" class="btn registerBtn">등록</button>
					</div>
				</form>
			</div>
		</div>
	</div>


 	
 	<script>
		$(document).ready(function () {
			$('.summernote').summernote({
				height: 400,
				minHeight: 400,
				maxHeight: null,
				focus: true
			});

			$('.boardContent .active').removeClass('active');
		});
 	</script>
</body>
</html>